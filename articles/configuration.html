<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configuration • safetyguide</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Configuration">
<meta property="og:description" content="Configuration for research codes
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safetyguide</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/configuration.html">Configuration</a>
    </li>
    <li>
      <a href="../articles/documentation.html">Documentation</a>
    </li>
    <li>
      <a href="../articles/formatting.html">Formatting</a>
    </li>
    <li>
      <a href="../articles/logging.html">Logging</a>
    </li>
    <li>
      <a href="../articles/organizing.html">Organization</a>
    </li>
    <li>
      <a href="../articles/packages.html">Packages</a>
    </li>
    <li>
      <a href="../articles/provenance.html">Provenance</a>
    </li>
    <li>
      <a href="../articles/testing.html">Testing</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="configuration_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Configuration</h1>
            
      
      
      <div class="hidden name"><code>configuration.Rmd</code></div>

    </div>

    
    
<div id="configuration" class="section level1">
<h1 class="hasAnchor">
<a href="#configuration" class="anchor"></a>Configuration</h1>
<p>There are two ways we configure our code, by command-line arguments and with configuration files that have parameters.</p>
<p>Sometimes organizations create methods for storing script parameters in a central database that’s specifically oriented for this. We won’t cover that here, but you can imagine that having a central store makes it easier to find what was used to run code in the past and record runs now.</p>
<div id="finding-files-and-databases" class="section level2">
<h2 class="hasAnchor">
<a href="#finding-files-and-databases" class="anchor"></a>Finding files and databases</h2>
<p>We run our code on laptops and on the cluster. Someone else will probably run this code next year. One of the problems with running code in different places, at different times, is that input files are changed and input databases have changed names. We can mitigate that problem by using a single layer of indirection.</p>
<div id="finding-files-in-the-project-directory" class="section level3">
<h3 class="hasAnchor">
<a href="#finding-files-in-the-project-directory" class="anchor"></a>Finding files in the project directory</h3>
<p>When you work in a package, different pieces of code can be run from different subdirectories, such as vignettes and scripts. To make this easier, you can reference files relative to the path of the package root. This command gives you the root of a package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/path_package.html">path_package</a></span><span class="op">(</span><span class="st">"safetyguide"</span><span class="op">)</span></code></pre></div>
<p>For more complicated situations, such as finding paths relative to the root of a git repository, the <a href="https://github.com/r-lib/rprojroot">rprojroot</a> package has you covered.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rprojroot</span><span class="fu">::</span><span class="fu"><a href="https://rprojroot.r-lib.org//reference/find_root.html">find_root</a></span><span class="op">(</span><span class="fu">rprojroot</span><span class="fu">::</span><span class="va"><a href="https://rprojroot.r-lib.org//reference/criteria.html">is_rstudio_project</a></span><span class="op">)</span>
<span class="fu">rprojroot</span><span class="fu">::</span><span class="fu"><a href="https://rprojroot.r-lib.org//reference/find_root.html">find_root</a></span><span class="op">(</span><span class="fu">rprojroot</span><span class="fu">::</span><span class="va"><a href="https://rprojroot.r-lib.org//reference/criteria.html">is_git_root</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="access-files-and-databases-through-a-pointer" class="section level3">
<h3 class="hasAnchor">
<a href="#access-files-and-databases-through-a-pointer" class="anchor"></a>Access files and databases through a pointer</h3>
<p>The goal is to run the same code on your laptop that you run on the cluster, and to do this reliably. We accomplish that by asking the code, when it starts, to check a configuration file in the environment. That configuration file will tell it which databases are available and where to find its input data.</p>
<p>Make a configuration file that has a <em>data root directory</em>. That way, you can define it to be in your Documents directory on your laptop, but under your team’s drive on the cluster. Then, in the code, access files by prepending the data root directory to the filename in the code.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataroot</span> <span class="op">&lt;-</span> <span class="fu">configr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/configr/man/read.config.html">read.config</a></span><span class="op">(</span><span class="st">"~/.config/dataroot"</span><span class="op">)</span><span class="op">[</span><span class="st">"dataroot"</span><span class="op">]</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">dataroot</span>, <span class="st">"/project/subdir/data"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="parameter-files" class="section level2">
<h2 class="hasAnchor">
<a href="#parameter-files" class="anchor"></a>Parameter Files</h2>
<p>When there are more than a few parameters, we can use a parameter file. The <a href="https://cran.r-project.org/web/packages/config/vignettes/introduction.html">configr package</a> can read parameter files written in <a href="https://yaml.org">YAML</a> or <a href="https://toml.io">TOML</a>. TOML has a more regular syntax, so let’s use that below.</p>
<p>Notice that the double-brackets are replaced with previously-defined values.</p>
<p>[versions] pfpr = “201029” am = “201029” outvars = “201122_1000”</p>
<p>[roles] pfpr = “/globalrc/inputs/PfPR_medians/{{pfpr}}” am = “/globalrc/inputs/AM_medians/{{am}}” outvars = “/globalrc/outputs/basicr/{{outvars}}”</p>
<p>[parameters] # These are scientific parameters. kam = 0.6 # modifies AM to get rho b = 0.55 # biting random_seed = 24243299 confidence_percent = 95 pfpr_min = 0.02 pfpr_max = 0.98</p>
<p>[options] # These affect computation but not output scientific numbers. blocksize = 16 pngres = 150</p>
<p>This parameter file uses the word “role” to refer to the role an input or output file plays for the script. It distinguishes options, which shouldn’t affect output scientific values, from parameters, which definitely do affect output scientific values.</p>
<p>The code can read te parameters section file with one command.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu">configr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/configr/man/read.config.html">read.config</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span><span class="op">[[</span><span class="st">"parameters"</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<p>The result is a named list of parameter values.</p>
<p>If we want to record, later, what paramters were used, we could copy this TOML file into an output data directory.</p>
</div>
<div id="command-line-arguments" class="section level2">
<h2 class="hasAnchor">
<a href="#command-line-arguments" class="anchor"></a>Command-line arguments</h2>
<p>There are several packages that help parse command-line arguments. A dependable choice is <a href="https://github.com/trevorld/r-argparse">argparse</a>. It looks like this: &gt; library(“argparse”) &gt; parser &lt;- ArgumentParser(description=‘Process some integers’) &gt; parser<span class="math inline">\(add_argument('integers', metavar='N', type="integer", nargs='+', + help='an integer for the accumulator') &gt; parser\)</span>add_argument(‘–sum’, dest=‘accumulate’, action=‘store_const’, + const=‘sum’, default=‘max’, + help=‘sum the integers (default: find the max)’) &gt; parser$print_help() usage: PROGRAM [-h] [–sum] N [N …]</p>
<p>Process some integers</p>
<p>positional arguments: N an integer for the accumulator</p>
<p>optional arguments: -h, –help show this help message and exit –sum sum the integers (default: find the max)</p>
<p>I’ll show <a href="https://github.com/docopt/docopt.R">docopt</a> below, but the same principles hold for both:</p>
<ul>
<li>If you parse parameters in a separate function, you can test that function more easily.</li>
<li>There are input parameters and these are translated into algorithm parameters. Doing this translation can speed up computation.</li>
</ul>
<p>Here’s an example of using docopt, which looks at a formatted usage string in order to guess what your parameters must be.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">arg_parser</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">args</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">doc</span> <span class="op">&lt;-</span> <span class="st">"pr to Rc
Usage:
  rc_kappa.R [options]
  rc_kappa.R (-h | --help)
Options:
  -h --help              Show help.
  --config=&lt;config&gt;      A configuration file.
  --country=&lt;alpha3&gt;     The three-letter country code for a country's outline.
  --outvars=&lt;outversion&gt; Version of output to write.
  --overwrite            Whether to overwrite outputs.
  --years=&lt;year_range&gt;   A range of years to do, as an R range, 2000:2010.
  --cores=&lt;core_cnt&gt;     Tell it how many cores to use in parallel.
  --draws=&lt;draw_cnt&gt;     How many draws to use.
  --task=&lt;task_id&gt;       If this is a task, which task.
  --tasks=&lt;task_cnt&gt;     Total number of tasks. You should set this for workers.
"</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">args</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">parsed_args</span> <span class="op">&lt;-</span> <span class="fu">docopt</span><span class="fu">::</span><span class="fu">docopt</span><span class="op">(</span><span class="va">doc</span>, version <span class="op">=</span> <span class="st">"rc_kappa 1.0"</span>, args <span class="op">=</span> <span class="va">args</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">parsed_args</span><span class="op">$</span><span class="va">config</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">parsed_args</span><span class="op">$</span><span class="va">config</span> <span class="op">&lt;-</span> <span class="st">"rc_kappa.toml"</span>
    <span class="op">}</span>
    <span class="va">parsed_args</span>
<span class="op">}</span></code></pre></div>
<p>This function accepts an <code>args</code> argument so that a unit test can pass in candidate versions of <code><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs()</a></code> output and check that they are parsed as expected.</p>
<p>It may seem silly to think about testing command-line parameters. I test them because I’ve had to change parameter values at 3 AM before submitting cluster jobs that would take a week to run. I really want to know I didn’t make a typo, before the job launches, so I add a test and run the test suite before submitting the job.</p>
<p>It is often the case that there is a difference between how you want to specify values to a program and what the core algorithm needs. For instance, you may specify a quantile in the input, and then the algorithm works with that quantile of a particular distribution. There is a translation step, and doing it once can save a little processing time. More importantly, it can make later calculation code clearer. This means there can be a parameter translation step early in the code, if you think that helps a particular code base.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andrew Dolgert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
