<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Provenance • safetyguide</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Provenance">
<meta property="og:description" content="Provenance for research applications
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safetyguide</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/configuration.html">Configuration</a>
    </li>
    <li>
      <a href="../articles/documentation.html">Documentation</a>
    </li>
    <li>
      <a href="../articles/formatting.html">Formatting</a>
    </li>
    <li>
      <a href="../articles/logging.html">Logging</a>
    </li>
    <li>
      <a href="../articles/organizing.html">Organization</a>
    </li>
    <li>
      <a href="../articles/packages.html">Packages</a>
    </li>
    <li>
      <a href="../articles/provenance.html">Provenance</a>
    </li>
    <li>
      <a href="../articles/testing.html">Testing</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="provenance_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Provenance</h1>
            
      
      
      <div class="hidden name"><code>provenance.Rmd</code></div>

    </div>

    
    
<div id="provenance" class="section level1">
<h1 class="hasAnchor">
<a href="#provenance" class="anchor"></a>Provenance</h1>
<p>Provenance is a record of how data was produced. It helps us figure out which algorithm made data. It answers questions about why my result is different from yours. We can do a pretty good job of tracking provenance in R. It takes a few little tools.</p>
</div>
<div id="primer-on-provenance" class="section level1">
<h1 class="hasAnchor">
<a href="#primer-on-provenance" class="anchor"></a>Primer on provenance</h1>
<p>There is a W3C <a href="https://www.w3.org/TR/prov-overview/">provenance description</a> that is thorough about what can be recorded and how to record it. That would be helpful if we were creating a provenance system for all of IHME, but it will help even our ad-hoc attempts if we understand a few categories.</p>
<p><em>Prospective and retrospective provenance</em> - Prospective provenance describes the action you plan to take. It’s the application you will run and arguments to call it with. It’s where to find the data to read. Retrospective provenance describes what did happen. It will include not only the filename read but the size of the file found on disk. It will include not only the command-line arguments as typed but the values read by the application after Bash translated them.</p>
<p>Prospective provenance tends to say more about what you plan to do and therefore more about why this action is being done.</p>
<p><em>Entities, agents, and activities</em> - Our goal is to make a causal record of the output of the research code, and that causal record is composed of entities, agents, and activities. Entities are files, database records, whole databases, or web pages. Agents are usually people, but they can refer to anything responsible for an action, such as a scheduler. An activity is something that consumes and produces entities. This is your program.</p>
<p>We are going to record all of that information, in a bit of a jumble, but someone should be able to piece together what activity created an entity and with what agent that activity was associated.</p>
</div>
<div id="what-to-save" class="section level1">
<h1 class="hasAnchor">
<a href="#what-to-save" class="anchor"></a>What to save</h1>
<ul>
<li>Command-line arguments</li>
<li>The script that was invoked</li>
<li>Parameter input files</li>
<li>Git commit hash, or MD5 hash of R source files</li>
<li>List of input files and database records, hashes of those files</li>
<li>List of output files and database records, hashes of those files</li>
<li>Record of running the program (who, when, what machine)</li>
</ul>
<p>That list is standard, but you could save more, if it’s relevant. For instance:</p>
<ul>
<li>The code could record which statistical model was used for particular functions.</li>
<li>Log files, all of them</li>
<li>A list of R packages loaded and their versions</li>
<li>A copy of the R script’s source code, in full</li>
<li>R’s version</li>
<li>Details about the processor architecture, memory of the machine</li>
</ul>
<p>How much you save depends on cost to write the code to gather the information and to store the data. Large organizations have a provenance budget, as a percentage of the size of total data, and it can be as high as thirty percent, because provenance makes the results more valuable.</p>
</div>
<div id="how-to-save-it" class="section level1">
<h1 class="hasAnchor">
<a href="#how-to-save-it" class="anchor"></a>How to save it</h1>
<p>There is a file in this repository called <code>provenance_spy.R</code>. Mike Richards wrote it, and I modified it. We will use it to record every file read and file write.</p>
<p>Record provenance before a file read, and include an argument to specify what role that file plays for this application, this time that it’s read.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"pr2ar.txt"</span>
<span class="fu"><a href="../reference/prov.input.file.html">prov.input.file</a></span><span class="op">(</span><span class="va">filename</span>, <span class="st">"pr-ar-matrix"</span><span class="op">)</span>
<span class="va">pr2ar</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span></code></pre></div>
<p>Record provenance of outputs after they are written, so that the code can compute the hash value of the written file. Again, add a role for that file.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raster_obj</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu">setValues</span><span class="op">(</span><span class="va">raster_obj</span>, <span class="va">ready_data</span><span class="op">)</span>
<span class="fu">raster</span><span class="fu">::</span><span class="fu">writeRaster</span><span class="op">(</span><span class="va">raster_obj</span>, filename <span class="op">=</span> <span class="va">out_fn</span>, format <span class="op">=</span> <span class="st">"GTiff"</span><span class="op">)</span>
<span class="fu"><a href="../reference/prov.output.file.html">prov.output.file</a></span><span class="op">(</span><span class="va">out_fn</span>, <span class="st">"rc"</span><span class="op">)</span></code></pre></div>
<p>At the end of the application, write the provenance to a file in the output directory.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/write.meta.data.html">write.meta.data</a></span><span class="op">(</span><span class="va">output_file</span><span class="op">)</span></code></pre></div>
<p>At the end, there will be a TOML file in the output directory containing every input, output, and command-line argument. That file is human-readable, but it can be read with <code>configr</code> in R, or by a TOML reader in Python, Julia, or C++.</p>
<p>That TOML looks, in part, like this, except that the inputs and outputs lists are longer. [application] [application.runtime] commandline_arguments = [ ‘/usr/local/lib/R/bin/exec/R’, ‘–no-save’, ‘–no-restore’, ‘–no-echo’, ‘–no-restore’, ‘–file=rc_kappa_run.R’, ‘–args’, ‘–config=210908_world.toml’, ‘–outvars=210909_single_world’, ‘–years=2019:2019’, ‘–cores=40’, ‘–draws=1000’ ] rversion = ‘4.0.5’ user = ‘adolgert’ node = ‘gen-uge-exec-p079’</p>
<p>[inputs] [inputs.de9a93e14392061f8ba24a3501590157d5bc235b9e7029380e10b64760a027a3] creation_time = 2021-09-08T18:35:42 last_modified = 2021-09-08T18:35:42 path = ‘/ihme/code/adolgert/dev/globalrc/scripts/210908_world.toml’ role = ‘configuration’ stack = [ ‘globalrc::main()’, ‘funcmain(args)’ ] sha256 = ‘6dd9eb8e68ea128f5bf57c0917fbd0856bdef697d2e79f3099be461dfc274ac7’</p>
<p>[inputs.8e39f2b7d7d676c428f4674a94c022dccf6b4f18eda1a575a9417a2cecf1e638] creation_time = 2020-11-20T19:02:13 last_modified = 2020-11-20T19:02:13 path = ‘/ihme/malaria_modeling/projects/globalrc/outputs/pr2ar_mesh/201105/pr2ar_mesh.csv’ role = ‘pr2ar’ stack = [ ‘globalrc::main()’, ‘funcmain(args)’, ‘load_data(args<span class="math inline">\(config,args\)</span>pr2ar,load_extent,args$years)’ ] sha256 = ‘56a2d7941a096e9ab8b88eab4ecca0b5e8c0929829d574898ed5cf8145ae89e2’</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andrew Dolgert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
